<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì»¤í…€ë¦¬ë“¬ í”Œë ˆì´ì–´ (v6.0)</title>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Black+Han+Sans&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <style>
        :root {
            --primary: #00d2ff;
            --secondary: #3a7bd5;
            --bg-dark: #121212;
            --panel-bg: #1e1e1e;
        }

        body {
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            /* [ì¤‘ìš”] ë°”ë””ì— í¬ì»¤ìŠ¤ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
            outline: none;
        }

        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜¤ë²„ë ˆì´ */
        #drop-zone {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 210, 255, 0.2);
            border: 5px dashed var(--primary);
            z-index: 9999; display: none;
            justify-content: center; align-items: center;
            font-size: 40px; font-weight: bold; color: #fff;
            text-shadow: 0 0 20px var(--primary); pointer-events: none;
            backdrop-filter: blur(5px);
        }
        body.dragover #drop-zone { display: flex; }

        h1 { 
            margin: 10px 0; 
            font-family: 'Black Han Sans', sans-serif; 
            font-size: 32px; 
            letter-spacing: 2px;
            background: linear-gradient(to right, var(--primary), #ff00de);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 210, 255, 0.5);
            cursor: pointer;
        }

        #container {
            display: flex; width: 95%; height: 85%; gap: 20px;
        }

        /* ì™¼ìª½ íŒ¨ë„ */
        #info-panel {
            flex: 1; background: var(--panel-bg); padding: 20px;
            border-radius: 15px; border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; gap: 15px;
            max-width: 320px; z-index: 10;
        }

        /* ê²Œì„ ì˜ì—­ */
        #game-area {
            flex: 2; position: relative;
            background: #000; border: 4px solid #333;
            border-radius: 10px; display: flex;
            justify-content: center; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 150, 255, 0.1);
            transform-origin: center;
            outline: none; /* í¬ì»¤ìŠ¤ ì•„ì›ƒë¼ì¸ ì œê±° */
        }
        
        /* [ìˆ˜ì •] í™”ë©´ í”ë“¤ë¦¼ ê·¹ì†Œí™” (0.5px ë‹¨ìœ„) */
        @keyframes shake {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-0.5px, 0.5px); }
            40% { transform: translate(0.5px, -0.5px); }
            60% { transform: translate(-0.5px, -0.5px); }
            80% { transform: translate(0.5px, 0.5px); }
            100% { transform: translate(0, 0); }
        }
        .shake { animation: shake 0.1s linear; }

        /* ë¯¸ë””ì–´ í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ */
        #media-hidden-container {
            position: absolute; left: -9999px; top: 0;
            width: 300px; height: 200px;
            visibility: hidden; pointer-events: none;
        }

        canvas { background: radial-gradient(circle, #1a1a1a 0%, #000000 100%); z-index: 1; }

        /* ëª¨ë‹¬ (Start / Result) */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .window-box {
            width: 400px; background: rgba(30, 30, 30, 0.95);
            border: 1px solid #555; border-top: 4px solid var(--primary);
            border-radius: 8px; padding: 25px;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
            text-align: center;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .window-title { font-family: 'Black Han Sans'; font-size: 24px; color: var(--primary); margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin: 8px 0; font-family: 'Roboto Mono'; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .stat-val { color: #fff; font-weight: bold; }

        .info-box { background: #2a2a2a; padding: 15px; border-radius: 8px; border: 1px solid #444; }
        
        button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s;
            font-family: 'Black Han Sans', sans-serif; color: white; margin-top: 5px;
        }
        button:hover { transform: scale(1.03); filter: brightness(1.2); }
        button:active { transform: scale(0.98); }
        button:focus { outline: none; } /* ë²„íŠ¼ í¬ì»¤ìŠ¤ ì œê±° */
        
        .btn-start { background: linear-gradient(45deg, var(--primary), var(--secondary)); box-shadow: 0 4px 15px rgba(0, 210, 255, 0.4); }
        .btn-restart { background: #444; margin-top: 10px; }
        .btn-editor { background: #333; color: #aaa; font-size: 14px; margin-top: auto; }
        
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; background: #222; padding: 10px; border-radius: 5px; }
        select { background: #333; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; }
        
        #score-display { font-family: 'Bangers'; font-size: 50px; text-align: center; color: #fff; text-shadow: 3px 3px 0 #000, 0 0 20px gold; margin-top: auto; }
        
        .key-guide { display: flex; justify-content: center; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .key-cap { background: #333; padding: 6px 12px; border-radius: 4px; border-bottom: 3px solid #111; font-family: 'Roboto Mono'; font-size: 14px; color: #ddd; transition: 0.1s; }
        .key-cap.active { background: var(--primary); color: #000; border-bottom: 3px solid #0088aa; transform: translateY(2px); box-shadow: 0 0 10px var(--primary); }

        .rank-s { color: #00d2ff; text-shadow: 0 0 20px #00d2ff; font-size: 80px; font-family: 'Bangers'; }
        .rank-a { color: #00ff00; text-shadow: 0 0 20px #00ff00; font-size: 80px; font-family: 'Bangers'; }
        .rank-b { color: #ffff00; text-shadow: 0 0 20px #ffff00; font-size: 80px; font-family: 'Bangers'; }
        .rank-f { color: #555; font-size: 80px; font-family: 'Bangers'; }

        #countdown-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Bangers', cursive; font-size: 120px; color: var(--primary);
            text-shadow: 0 0 50px black; z-index: 200; display: none;
            animation: popUp 0.4s ease-out;
        }

        #loading-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Black Han Sans', sans-serif;
            font-size: 30px; color: var(--primary); display: none; text-shadow: 0 0 15px black;
            animation: pulse 1s infinite; pointer-events: none; z-index: 50;
        }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
    </style>
</head>
<body tabindex="0"> <!-- í¬ì»¤ìŠ¤ë¥¼ ë°›ê¸° ìœ„í•´ tabindex ì¶”ê°€ -->

    <div id="drop-zone">ğŸ“‚ ì—¬ê¸°ì— íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”!</div>

    <h1 onclick="location.reload()">âš¡ ì»¤í…€ë¦¬ë“¬ í”Œë ˆì´ì–´ v6.0</h1>

    <div id="container">
        <div id="info-panel">
            <div class="info-box">
                <h3 style="margin:0 0 5px 0; color:var(--primary);">ğŸ“ FILE INFO</h3>
                <div id="ui-filename" style="font-size:16px; color:#fff; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">íŒŒì¼ ì—†ìŒ</div>
                <div id="ui-meta" style="font-size:12px; color:#aaa; margin-top:5px;">-</div>
            </div>

            <button class="btn-restart" onclick="document.getElementById('file-input').click()" style="background:#444;">ğŸ“‚ íŒŒì¼ ì—´ê¸° (.crn)</button>
            <input type="file" id="file-input" accept=".crn,.json" style="display: none;" onchange="loadFile(this)">
            
            <div class="info-box" style="margin-top:10px;">
                <h3 style="margin:0 0 10px 0; color:#ddd;">âš™ï¸ IN-GAME</h3>
                <div id="key-guide-container" class="key-guide"></div>
                <div id="debug-time" style="font-family:'Roboto Mono'; font-size:11px; color:#555; text-align:center; margin-top:5px;">00:00.000</div>
            </div>

            <div id="score-display">000000</div>
            <button class="btn-editor" onclick="location.href='./editor.html'">âœï¸ í¸ì§‘ê¸°</button>
        </div>

        <div id="game-area">
            <canvas id="gameCanvas" width="500" height="750"></canvas>
            <div id="loading-text">BUFFERING...</div>
            <div id="countdown-overlay">3</div>
            
            <div id="start-modal" class="modal-overlay">
                <div class="window-box">
                    <div class="window-title">ğŸš€ MISSION BRIEFING</div>
                    <div class="stat-row"><span>SONG URL</span><span class="stat-val" id="start-title" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">-</span></div>
                    <div class="stat-row"><span>KEY MODE</span><span class="stat-val" id="start-key">-</span></div>
                    <div class="stat-row"><span>TOTAL NOTES</span><span class="stat-val" id="start-notes">-</span></div>
                    <div class="stat-row"><span>OFFSET</span><span class="stat-val" id="start-offset">0.000</span></div>
                    
                    <div class="toggle-row">
                        <span style="font-size:14px; font-weight:bold;">SPEED</span>
                        <input type="range" id="speed-range" min="1.0" max="6.0" step="0.1" value="2.5" style="width:100px" oninput="updateSpeedUI(this.value)">
                        <span id="speed-val" style="width:30px; text-align:right;">2.5</span>
                    </div>

                    <div class="toggle-row">
                        <span style="font-size:14px; font-weight:bold;">HIT SOUND</span>
                        <select id="sound-select">
                            <option value="default">Default (Clap)</option>
                            <option value="chip">Chip (8-bit)</option>
                            <option value="kick">Low (Kick)</option>
                            <option value="off">OFF (Mute)</option>
                        </select>
                    </div>

                    <!-- í¬ì»¤ìŠ¤ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ onclickì—ì„œ í•¨ìˆ˜ ì‹¤í–‰ í›„ blur() í˜¸ì¶œ -->
                    <button class="btn-start" onclick="initGameFlow(this)">GAME START</button>
                </div>
            </div>

            <div id="result-modal" class="modal-overlay">
                <div class="window-box">
                    <div class="window-title">ğŸ† RESULT</div>
                    <div id="result-rank" class="rank-f">F</div>
                    <div class="stat-row" style="margin-top:20px; color:#00d2ff;"><span>PERFECT</span><span class="stat-val" id="res-perfect">0</span></div>
                    <div class="stat-row" style="color:#00ff00;"><span>GREAT</span><span class="stat-val" id="res-great">0</span></div>
                    <div class="stat-row" style="color:#888;"><span>MISS</span><span class="stat-val" id="res-miss">0</span></div>
                    <!-- [ìˆ˜ì •] MAX COMBO í‘œì‹œë€ ì¶”ê°€ -->
                    <div class="stat-row" style="color:#ffaa00;"><span>MAX COMBO</span><span class="stat-val" id="res-combo">0</span></div>
                    <div class="stat-row" style="border-top:2px solid #555; margin-top:10px; padding-top:10px; font-size:18px;">
                        <span>FINAL SCORE</span><span class="stat-val" id="res-score">0</span>
                    </div>
                    <button class="btn-start" onclick="initGameFlow(this)">REPLAY</button>
                    <button class="btn-restart" onclick="closeResult()">SELECT OTHER SONG</button>
                </div>
            </div>
            
            <div id="media-hidden-container">
                <div id="yt-player"></div>
                <iframe id="sc-player" width="100%" height="166" scrolling="no" frameborder="no" allow="autoplay; encrypted-media" 
                    src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/293&color=%23ff5500&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&show_teaser=false&visual=false">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        const HIT_LINE_Y = 620; 
        const BASE_PIXELS_PER_SECOND = 400; 
        let pixelsPerSecond = 400;
        
        let mapData = null; 
        let notes = []; 
        let laneCount = 4;
        
        let isPlaying = false; 
        let isBuffering = false;
        let isCountdown = false;
        let countdownStartTime = 0;
        let currentTime = 0;
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let judgeStats = { perfect: 0, great: 0, miss: 0 };
        let focusGuardTimer = null;
        
        let ytPlayer = null;
        let scWidget = null;
        let activeProvider = null;
        let scStartTime = 0;
        let scPlayOffset = 0;

        // [ì‹ ê·œ] ë¡±ë…¸íŠ¸ ìƒíƒœ ì¶”ì 
        const holdingNotes = {}; // { 0: noteObject, 1: noteObject, ... }
        
        const KEY_MAPPING = {
            2: { 'KeyD': 0, 'KeyF': 0, 'KeyJ': 1, 'KeyK': 1 }, 
            4: { 'KeyD': 0, 'KeyF': 1, 'KeyJ': 2, 'KeyK': 3 },
            6: { 'KeyS': 0, 'KeyD': 1, 'KeyF': 2, 'KeyJ': 3, 'KeyK': 4, 'KeyL': 5 }
        };
        // [ì‹ ê·œ] KeyUp ì´ë²¤íŠ¸ë¥¼ ìœ„í•œ ì—­ë°©í–¥ ë§¤í•‘
        const REVERSE_KEY_MAPPING = {
            'KeyD': {2: 0, 4: 0, 6: 1}, 'KeyF': {2: 0, 4: 1, 6: 2}, 'KeyJ': {2: 1, 4: 2, 6: 3}, 'KeyK': {2: 1, 4: 3, 6: 4},
            'KeyS': {6: 0}, 'KeyL': {6: 5}
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        let particles = [];
        let judgeText = { text: "", color: "", time: 0, scale: 1 };
        let laneEffects = []; 

        window.onload = () => {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

            const iframe = document.getElementById('sc-player');
            scWidget = SC.Widget(iframe);
            scWidget.bind(SC.Widget.Events.FINISH, endGame);

            scWidget.bind(SC.Widget.Events.PLAY, () => {
                if (isBuffering && activeProvider === 'soundcloud') {
                    scWidget.pause(); scWidget.seekTo(0); scWidget.setVolume(100);
                    startCountdown();
                } else if (isPlaying) {
                    scStartTime = Date.now();
                    scWidget.getPosition((p) => scPlayOffset = p / 1000);
                }
            });

            window.addEventListener('blur', function() { if(isPlaying || isCountdown || isBuffering) { window.focus(); } });

            const dz = document.getElementById('drop-zone');
            document.body.addEventListener('dragover', e => { e.preventDefault(); document.body.classList.add('dragover'); });
            document.body.addEventListener('dragleave', e => { e.preventDefault(); if(e.relatedTarget === null || e.relatedTarget.id !== 'drop-zone') document.body.classList.remove('dragover'); });
            document.body.addEventListener('drop', e => {
                e.preventDefault(); document.body.classList.remove('dragover');
                if(e.dataTransfer.files.length) loadFile({files: e.dataTransfer.files});
            });

            requestAnimationFrame(gameLoop);
        };

        window.onYouTubeIframeAPIReady = function() {
            ytPlayer = new YT.Player('yt-player', {
                height: '200', width: '200',
                playerVars: { 'controls': 0, 'disablekb': 1, 'playsinline': 1 },
                events: {
                    'onStateChange': (e) => {
                        if (isBuffering && e.data === YT.PlayerState.PLAYING) {
                            ytPlayer.pauseVideo(); ytPlayer.seekTo(0); ytPlayer.unMute();
                            startCountdown();
                        }
                        if (isPlaying && e.data === YT.PlayerState.ENDED) endGame();
                    }
                }
            });
        };

        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!json.d) throw new Error("ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ì…ë‹ˆë‹¤.");
                    
                    mapData = json;
                    mapData.keyMode = parseInt(mapData.keyMode) || 4;
                    laneCount = mapData.keyMode;
                    
                    document.getElementById('ui-filename').innerText = file.name;
                    document.getElementById('ui-meta').innerText = `BPM: ${json.bpm} | OFFSET: ${json.offset}`;
                    document.getElementById('start-title').innerText = json.url || "No URL";
                    document.getElementById('start-key').innerText = `${json.keyMode} KEY`;
                    document.getElementById('start-notes').innerText = json.d.length;
                    document.getElementById('start-offset').innerText = json.offset;
                    updateKeyGuide(json.keyMode);
                    if (json.speed) { document.getElementById('speed-range').value = json.speed; updateSpeedUI(json.speed); }
                    document.getElementById('start-modal').style.display = 'flex';
                    document.getElementById('result-modal').style.display = 'none';
                } catch (err) { alert("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: " + err.message); }
            };
            reader.readAsText(file);
            input.value = "";
        }

        function updateKeyGuide(mode) {
            const container = document.getElementById('key-guide-container');
            container.innerHTML = '';
            let keys = (mode === 2) ? ['D/F', 'J/K'] : (mode === 4) ? ['D', 'F', 'J', 'K'] : ['S', 'D', 'F', 'J', 'K', 'L'];
            keys.forEach(k => { const div = document.createElement('div'); div.className = 'key-cap'; div.innerText = k; container.appendChild(div); });
        }
        function updateSpeedUI(val) { document.getElementById('speed-val').innerText = parseFloat(val).toFixed(1); }

        function initGameFlow(btn) {
            if (!mapData) return;
            if(btn) btn.blur(); 
            
            document.getElementById('start-modal').style.display = 'none';
            document.getElementById('result-modal').style.display = 'none';
            document.getElementById('score-display').innerText = "000000";
            
            notes = mapData.d.map(arr => ({ time: Number(arr[0]), col: parseInt(arr[1]), duration: Number(arr[2] || 0), hit: false, missed: false, processed: false, holdTick: 0 })).sort((a,b) => a.time - b.time);
            let minCol = 999, maxCol = -1;
            notes.forEach(n => { if (n.col < minCol) minCol = n.col; if (n.col > maxCol) maxCol = n.col; });
            if (minCol >= 1 && maxCol <= laneCount) notes.forEach(n => n.col = n.col - 1);

            const speedMult = parseFloat(document.getElementById('speed-range').value);
            pixelsPerSecond = BASE_PIXELS_PER_SECOND * speedMult;

            score = 0; combo = 0; maxCombo = 0;
            judgeStats = { perfect: 0, great: 0, miss: 0 };
            laneEffects = new Array(mapData.keyMode).fill(0);
            Object.keys(holdingNotes).forEach(key => delete holdingNotes[key]); // í™€ë”© ë…¸íŠ¸ ì´ˆê¸°í™”

            startFocusGuard();
            startBuffering(mapData.url);
        }

        function startBuffering(url) {
            if (!url) { alert("URLì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            isBuffering = true;
            document.getElementById('loading-text').style.display = 'block';
            document.getElementById('loading-text').innerText = "BUFFERING...";
            
            if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
            if (scWidget) scWidget.pause();

            if (url.includes('youtu')) {
                activeProvider = 'youtube';
                const id = getYoutubeId(url);
                ytPlayer.loadVideoById(id);
                ytPlayer.mute();
            } else if (url.includes('soundcloud')) {
                activeProvider = 'soundcloud';
                scWidget.load(url, { auto_play: true, visual: false });
                scWidget.setVolume(0);
            } else {
                alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” URLì…ë‹ˆë‹¤.");
            }
        }
        
        function startCountdown() {
            isBuffering = false;
            document.getElementById('loading-text').style.display = 'none';
            document.getElementById('countdown-overlay').style.display = 'block';
            isCountdown = true;
            countdownStartTime = Date.now();
            const countEl = document.getElementById('countdown-overlay');
            let count = 3;
            countEl.innerText = count;
            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countEl.innerText = count;
                    countEl.style.animation = 'none'; countEl.offsetHeight; 
                    countEl.style.animation = 'popUp 0.4s ease-out';
                } else {
                    clearInterval(timer);
                    countEl.style.display = 'none';
                    realStartGame(); 
                }
            }, 1000);
        }

        function realStartGame() {
            isCountdown = false;
            isPlaying = true;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (activeProvider === 'youtube') { ytPlayer.playVideo(); } 
            else if (activeProvider === 'soundcloud') { scWidget.play(); }
            console.log("[System] Music Started. Inputs Active.");
        }

        function startFocusGuard() {
            if(focusGuardTimer) clearInterval(focusGuardTimer);
            focusGuardTimer = setInterval(() => {
                if (isPlaying || isCountdown) {
                    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
                        document.activeElement.blur(); window.focus(); document.body.focus();
                    } else if (document.hasFocus() === false) { window.focus(); }
                }
            }, 100);
        }

        function getYoutubeId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- [ìˆ˜ì •] ê²Œì„ ë£¨í”„ ë¶„ë¦¬ ---
        function gameLoop() {
            if (isPlaying || isCountdown) {
                updateTime();
                updateGameLogic();
                renderGame();
                checkForGameEnd(); // ê²Œì„ ì¢…ë£Œ ì¡°ê±´ í™•ì¸
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            requestAnimationFrame(gameLoop);
        }
        
        function updateTime() {
            if (isCountdown) {
                const elapsed = (Date.now() - countdownStartTime) / 1000;
                currentTime = elapsed - 3.0;
            } else if (isPlaying) {
                if (activeProvider === 'youtube' && ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                    currentTime = ytPlayer.getCurrentTime();
                } else if (activeProvider === 'soundcloud') {
                    currentTime = scPlayOffset + (Date.now() - scStartTime) / 1000;
                }
            }
            document.getElementById('debug-time').innerText = currentTime.toFixed(3);
        }

        // [ì‹ ê·œ] ê²Œì„ ë¡œì§ ì—…ë°ì´íŠ¸ (íŒì •, ë¡±ë…¸íŠ¸ ì²˜ë¦¬ ë“±)
        function updateGameLogic() {
            if (!isPlaying) return;

            const renderOffset = mapData ? (mapData.offset || 0) : 0;
            const judgeTime = currentTime + renderOffset;

            notes.forEach(note => {
                if (note.processed || note.missed) return;

                // 1. ì¼ë°˜ ë…¸íŠ¸ & ë¡±ë…¸íŠ¸ í—¤ë“œ Miss ì²˜ë¦¬
                if (!note.hit && judgeTime > note.time + 0.2) {
                    note.missed = true;
                    note.processed = true;
                    combo = 0;
                    judgeStats.miss++;
                    triggerJudge("MISS", '#888');
                    updateScoreDisplay();
                }

                // 2. ë¡±ë…¸íŠ¸ í™€ë“œ ì²˜ë¦¬
                if (note.hit && note.duration > 0) {
                    const endTime = note.time + note.duration;

                    // í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆëŠ” ê²½ìš°
                    if (holdingNotes[note.col] === note) {
                        // ë¡±ë…¸íŠ¸ê°€ ëë‚˜ëŠ” ì‹œê°„ì„ ì§€ë‚¬ë‹¤ë©´
                        if (judgeTime >= endTime) {
                            note.processed = true;
                            delete holdingNotes[note.col];
                            // ë¡±ë…¸íŠ¸ ë íŒì •ì€ ë¬´ì¡°ê±´ PERFECT
                            judgeStats.perfect++; score += 300; // ì¶”ê°€ ì ìˆ˜
                            triggerJudge("PERFECT", "#00d2ff");
                            updateScoreDisplay();
                        } else {
                            // ë¡±ë…¸íŠ¸ë¥¼ ëˆ„ë¥´ê³  ìˆëŠ” ë™ì•ˆ ì£¼ê¸°ì ìœ¼ë¡œ ì½¤ë³´/ì ìˆ˜ ì˜¬ë¦¬ê¸°
                            const tickInterval = 0.1; // 0.1ì´ˆë§ˆë‹¤
                            if (judgeTime > note.time + (note.holdTick + 1) * tickInterval) {
                                note.holdTick++;
                                combo++;
                                if (combo > maxCombo) maxCombo = combo;
                                score += 50;
                                laneEffects[note.col] = 0.5;
                                updateScoreDisplay();
                            }
                        }
                    }
                    // í‚¤ë¥¼ ë—ëŠ”ë° ì•„ì§ ë…¸íŠ¸ê°€ ëë‚˜ì§€ ì•Šì€ ê²½ìš° (ì¤‘ê°„ì— ë†“ì¹¨)
                    else if(judgeTime < endTime) {
                         note.missed = true;
                         note.processed = true;
                         combo = 0;
                         judgeStats.miss++;
                         triggerJudge("MISS", "#888");
                         updateScoreDisplay();
                    }
                }
            });
        }

        function renderGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const laneWidth = canvas.width / laneCount;
            const renderOffset = mapData ? (mapData.offset || 0) : 0;

            for(let i=0; i<laneCount; i++) {
                if (laneEffects[i] > 0) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${laneEffects[i] * 0.3})`;
                    ctx.fillRect(i*laneWidth, 0, laneWidth, canvas.height);
                    laneEffects[i] -= 0.08; 
                }
                if (i > 0) {
                    ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(i*laneWidth, 0); ctx.lineTo(i*laneWidth, canvas.height); ctx.stroke();
                }
            }

            ctx.strokeStyle = '#00d2ff'; ctx.lineWidth = 3;
            ctx.shadowBlur = 20; ctx.shadowColor = '#00d2ff';
            ctx.beginPath(); ctx.moveTo(0, HIT_LINE_Y); ctx.lineTo(canvas.width, HIT_LINE_Y); ctx.stroke();
            ctx.shadowBlur = 0;

            if(notes) {
                notes.forEach(note => {
                    if (note.processed) return;

                    const noteY = HIT_LINE_Y - (note.time - renderOffset - currentTime) * pixelsPerSecond;
                    if (noteY < -300 || noteY > canvas.height + 200) return;

                    const x = note.col * laneWidth;
                    let color = (laneCount === 4) ? ((note.col === 0 || note.col === 3) ? '#ff4d4d' : '#4d4dff') : ((note.col % 2 === 0) ? '#ff4d4d' : '#4d4dff');

                    if (note.duration > 0) {
                        const tailHeight = note.duration * pixelsPerSecond;
                        let drawY = noteY;
                        let drawH = tailHeight;

                        if (note.hit) {
                            drawY = HIT_LINE_Y;
                            const endTime = note.time + note.duration;
                            const remain = endTime - (currentTime + renderOffset);
                            drawH = remain * pixelsPerSecond;
                        }
                        
                        if(drawY - drawH < canvas.height && drawY > 0) {
                            ctx.fillStyle = color; ctx.globalAlpha = 0.6;
                            ctx.fillRect(x + 5, drawY - drawH, laneWidth - 10, drawH);
                            ctx.fillStyle = '#fff'; ctx.globalAlpha = 0.3;
                            ctx.fillRect(x + laneWidth/2 - 2, drawY - drawH, 4, drawH);
                            ctx.globalAlpha = 1.0;
                        }
                    }

                    if (!note.hit) {
                        ctx.shadowBlur = 15; ctx.shadowColor = color;
                        ctx.fillStyle = color;
                        ctx.beginPath(); ctx.roundRect(x + 4, noteY - 20, laneWidth - 8, 20, 4); ctx.fill();
                        ctx.fillStyle = "rgba(255,255,255,0.7)"; ctx.fillRect(x + 4, noteY - 20, laneWidth - 8, 6); ctx.shadowBlur = 0;
                    }
                });
            }

            drawParticles(); drawJudgeText(); drawCombo();
        }

        // --- [ìˆ˜ì •] ì…ë ¥ ì²˜ë¦¬ (KeyDown) ---
        function handleInput(col) {
            if (!mapData) return;
            laneEffects[col] = 1.0; 

            if (!isPlaying) return;

            const PERFECT = 0.050, GREAT = 0.120, MISS = 0.200; 
            const renderOffset = mapData.offset || 0;
            const judgeTime = currentTime + renderOffset;

            let bestNote = null, minDiff = Infinity;
            notes.forEach(note => {
                if (note.col === col && !note.hit && !note.missed) {
                    const diff = Math.abs(note.time - judgeTime);
                    if (diff < minDiff) { minDiff = diff; bestNote = note; }
                }
            });

            if (bestNote && minDiff <= MISS) {
                bestNote.hit = true;
                let judge = "MISS", color = "#888";

                if (minDiff <= PERFECT) {
                    judge = "PERFECT"; color = "#00d2ff";
                    score += 1000 + (combo * 10); combo++; judgeStats.perfect++;
                    screenShake();
                } else if (minDiff <= GREAT) {
                    judge = "GREAT"; color = "#00ff00";
                    score += 500 + (combo * 5); combo++; judgeStats.great++;
                } else {
                    combo = 0; judgeStats.miss++; bestNote.missed = true;
                }

                // [ì‹ ê·œ] ë¡±ë…¸íŠ¸ì¸ ê²½ìš° í™€ë”© ìƒíƒœë¡œ ì „í™˜
                if (bestNote.duration > 0 && !bestNote.missed) {
                    holdingNotes[col] = bestNote;
                } else {
                    bestNote.processed = true; // ì¼ë°˜ ë…¸íŠ¸ëŠ” ë°”ë¡œ ì²˜ë¦¬ ì™„ë£Œ
                }

                if (combo > maxCombo) maxCombo = combo;
                if (!bestNote.missed) {
                    const laneWidth = canvas.width / mapData.keyMode;
                    const centerX = (col + 0.5) * laneWidth;
                    spawnShockwave(centerX, HIT_LINE_Y, color);
                    spawnSparks(centerX, HIT_LINE_Y, color);
                }
                try { playHitSound(); } catch(e) {}
                triggerJudge(judge, color);
                updateScoreDisplay();
            }
        }
        
        // [ì‹ ê·œ] ì…ë ¥ ì²˜ë¦¬ (KeyUp)
        function handleRelease(col) {
            if (holdingNotes[col]) {
                const note = holdingNotes[col];
                const renderOffset = mapData.offset || 0;
                const judgeTime = currentTime + renderOffset;
                const endTime = note.time + note.duration;

                // ë…¸íŠ¸ê°€ ëë‚˜ê¸° ì „ì— í‚¤ë¥¼ ë—€ ê²½ìš°
                if (judgeTime < endTime - 0.1) { // 0.1ì´ˆì˜ ì—¬ìœ 
                    note.missed = true;
                    note.processed = true;
                    combo = 0;
                    judgeStats.miss++;
                    triggerJudge("MISS", '#888');
                    updateScoreDisplay();
                }
                delete holdingNotes[col];
            }
        }

        const pressedKeys = {};
        window.addEventListener('keydown', e => {
            if (e.repeat || pressedKeys[e.code]) return; 
            pressedKeys[e.code] = true;
            if (mapData && KEY_MAPPING[mapData.keyMode]) {
                const col = KEY_MAPPING[mapData.keyMode][e.code];
                if (col !== undefined) handleInput(col);
            }
        });
        window.addEventListener('keyup', e => {
            pressedKeys[e.code] = false;
            if (mapData && REVERSE_KEY_MAPPING[e.code]) {
                const col = REVERSE_KEY_MAPPING[e.code][mapData.keyMode];
                if (col !== undefined) handleRelease(col);
            }
        });

        function playHitSound() {
            const type = document.getElementById('sound-select').value;
            if (type === 'off') return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'default') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.1);
                gain.gain.setValueAtTime(0.8, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'chip') {
                osc.type = 'square'; osc.frequency.setValueAtTime(880, t);
                gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t + 0.05);
                osc.start(t); osc.stop(t + 0.05);
            } else if (type === 'kick') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.2);
                gain.gain.setValueAtTime(1.0, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
                osc.start(t); osc.stop(t + 0.2);
            }
        }
        function spawnSparks(x, y, color) { for(let i=0; i<15; i++) { const angle = Math.random() * Math.PI - (Math.PI/2); const speed = Math.random() * 12 + 6; particles.push({ type: 'spark', x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1.0, color: color, gravity: 0.6 }); } }
        function spawnShockwave(x, y, color) { particles.push({ type: 'shockwave', x: x, y: y, size: 10, alpha: 1.0, color: color }); }
        function drawParticles() { for(let i=particles.length-1; i>=0; i--) { const p = particles[i]; if (p.type === 'spark') { p.x += p.vx; p.y += p.vy; p.vy += p.gravity; p.life -= 0.03; if(p.life <= 0) particles.splice(i, 1); else { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 4 * p.life, 0, Math.PI*2); ctx.fill(); } } else if (p.type === 'shockwave') { p.size += 6; p.alpha -= 0.06; if(p.alpha <= 0) particles.splice(i, 1); else { ctx.strokeStyle = p.color; ctx.lineWidth = 5; ctx.globalAlpha = p.alpha; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.stroke(); } } } ctx.globalAlpha = 1.0; }
        function triggerJudge(text, color) { judgeText = { text, color, time: 20, scale: 0.5 }; }
        function drawJudgeText() { if (judgeText.time > 0) { ctx.save(); ctx.translate(canvas.width/2, HIT_LINE_Y - 200); let t = 1 - (judgeText.time / 20); let scale = 1 + Math.sin(t * Math.PI * 3) * 0.3 * (1-t); ctx.scale(scale, scale); ctx.font = "bold 50px 'Black Han Sans'"; ctx.textAlign = "center"; ctx.fillStyle = judgeText.color; ctx.shadowBlur = 15; ctx.shadowColor = judgeText.color; ctx.fillText(judgeText.text, 0, 0); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.strokeText(judgeText.text, 0, 0); ctx.restore(); judgeText.time--; } }
        function drawCombo() { if (combo > 2) { ctx.save(); const pulse = 1 + (combo % 5 === 0 ? 0.2 : 0); ctx.translate(canvas.width/2, HIT_LINE_Y - 120); ctx.scale(pulse, pulse); ctx.font = "italic bold 60px 'Bangers'"; ctx.textAlign = "center"; ctx.fillStyle = "#fff"; ctx.shadowBlur = 10; ctx.shadowColor = "#00d2ff"; ctx.fillText(combo, 0, 0); ctx.restore(); } }
        function screenShake() { const area = document.getElementById('game-area'); area.classList.remove('shake'); void area.offsetWidth; area.classList.add('shake'); }
        function updateScoreDisplay() { document.getElementById('score-display').innerText = String(Math.floor(score)).padStart(6, '0'); }

        // [ì‹ ê·œ] ê²Œì„ ì¢…ë£Œ ì¡°ê±´ í™•ì¸
        function checkForGameEnd() {
            if (!isPlaying || !notes || notes.length === 0) return;
            
            const allNotesProcessed = notes.every(n => n.processed || n.missed);
            if (allNotesProcessed) {
                // ë§ˆì§€ë§‰ ë…¸íŠ¸ ì‹œê°„ ì°¾ê¸°
                const lastNoteTime = notes[notes.length - 1].time + (notes[notes.length - 1].duration || 0);
                // ë§ˆì§€ë§‰ ë…¸íŠ¸ í›„ 3ì´ˆê°€ ì§€ë‚˜ë©´ ê°•ì œ ì¢…ë£Œ
                if (currentTime > lastNoteTime + 3) {
                    console.log("[System] All notes processed. Forcing end game.");
                    endGame();
                }
            }
        }
        
        // [ìˆ˜ì •] endGame í•¨ìˆ˜
        function endGame() {
            if (!isPlaying && !isCountdown) return; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

            isPlaying = false;
            isCountdown = false;
            clearInterval(focusGuardTimer);
            if (activeProvider === 'youtube' && ytPlayer) ytPlayer.stopVideo(); 
            if (activeProvider === 'soundcloud' && scWidget) scWidget.pause();
            
            document.getElementById('res-perfect').innerText = judgeStats.perfect;
            document.getElementById('res-great').innerText = judgeStats.great;
            document.getElementById('res-miss').innerText = judgeStats.miss;
            document.getElementById('res-combo').innerText = maxCombo;
            document.getElementById('res-score').innerText = Math.floor(score).toLocaleString();
            
            const total = notes.length;
            const acc = total > 0 ? (judgeStats.perfect + judgeStats.great * 0.5) / total : 0;
            const rankEl = document.getElementById('result-rank');
            
            if (judgeStats.miss === 0 && acc >= 0.98) { rankEl.innerText = "S"; rankEl.className = "rank-s"; }
            else if (acc >= 0.9) { rankEl.innerText = "A"; rankEl.className = "rank-a"; }
            else if (acc >= 0.8) { rankEl.innerText = "B"; rankEl.className = "rank-b"; }
            else { rankEl.innerText = "F"; rankEl.className = "rank-f"; }
            
            document.getElementById('result-modal').style.display = 'flex';
        }
        
        function closeResult() { 
            document.getElementById('result-modal').style.display = 'none'; 
            document.getElementById('file-input').click(); 
        }
    </script>
</body>
</html>